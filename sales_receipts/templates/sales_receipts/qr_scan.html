{% extends "base.html" %}

{% block title %}QR Kod Skeniranje{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-6">
            <video id="camera" autoplay></video>
            <br/>
            <button class="btn btn-primary" onclick="capture()">Slikaj</button>
        </div>
        <div class="col-md-6">
            <canvas id="canvas" style="display: none;"></canvas>
            <img id="photo" style="display: none;" />
            <form id="upload-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="image" id="image-input">
                <button class="btn btn-primary" type="submit">Pošalji na server</button>
            </form>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <p>Rezultat: <span id="result"></span></p>
        </div>
    </div>
{% endblock %}

{% block script %}
    const video = document.getElementById("camera");
    const canvas = document.getElementById("canvas");
    const photo = document.getElementById("photo");
    const imageDataInput = document.getElementById("image-data");

    // Pokretanje kamere - koristi zadnju kameru ako je dostupna
    navigator.mediaDevices.enumerateDevices()
        .then(devices => {
            // Pronađi zadnju kameru
            const backCamera = devices.find(device => device.kind === "videoinput" && device.label.toLowerCase().includes("back"));

            const constraints = {
                video: {
                    deviceId: backCamera ? { exact: backCamera.deviceId } : undefined,
                    facingMode: { ideal: "environment" }  // Podesi kameru na zadnju
                }
            };

            // Pokreni kameru
            navigator.mediaDevices.getUserMedia(constraints)
                .then((stream) => {
                    video.srcObject = stream;
                })
                .catch((err) => {
                    console.error("Kamera nije dostupna:", err);
                });
        });

    // Funkcija za slikanje
    function capture() {
        const context = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Konvertuj sliku u Base64 format
        const imageData = canvas.toDataURL("image/png");
        photo.src = imageData;
        photo.style.display = "block";
        imageDataInput.value = imageData; // Postavi vrednost za slanje
    }

    // AJAX slanje slike
    document.getElementById("upload-form").addEventListener("submit", function(event) {
        event.preventDefault();

        const formData = new FormData(this);
        fetch("{% url 'sales_receipts:qr_upload' %}", {
            method: "POST",
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById("result").innerText = data.result;
        })
        .catch(error => console.error("Greška:", error));
    });
{% endblock %}

{% block style %}
    <style>
        #camera {
            width: 100%;
            height: auto;
            border: 1px solid #ddd;
        }
        video {
            max-width: 100%;
            height: auto;
        }
    </style>
{% endblock %}
